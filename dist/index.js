"use strict";var e,i=Object.defineProperty,t=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,o=(e,i,t)=>new Promise(((r,n)=>{var o=e=>{try{d(t.next(e))}catch(e){n(e)}},s=e=>{try{d(t.throw(e))}catch(e){n(e)}},d=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,s);d((t=t.apply(e,i)).next())})),s={};((e,t)=>{for(var r in t)i(e,r,{get:t[r],enumerable:!0})})(s,{AuthError:()=>c,Client:()=>l}),module.exports=(e=s,((e,o,s,d)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let c of r(o))n.call(e,c)||c===s||i(e,c,{get:()=>o[c],enumerable:!(d=t(o,c))||d.enumerable});return e})(i({},"__esModule",{value:!0}),e));var d=require("ncrypt-js"),c=class extends Error{constructor(e){super(e)}},l=class{constructor(e,i){var t,r;if(this.models=e,!i.secret)throw new c("Secret is required.");this.sessionExpiresIn=null!=(t=i.sessionExpiresIn)?t:108e5,this.codeExpiresIn=null!=(r=i.sessionExpiresIn)?r:9e5;const n=new d.ncrypt(i.secret);this.ncrypt=n,this.mailer=i.mailer}encode(e){return this.ncrypt.encrypt(e)}decode(e){return this.ncrypt.decrypt(e).toString()}generateVerificationCode(){return Math.floor(1e7+9e7*Math.random()).toString()}getVerificationCode(e){return o(this,null,(function*(){const i=yield this.models.user.findByEmail(e);if(!i)throw new c("User not found.");const t=yield this.models.verificationCode.findByUserId(i.id);if(t)return yield this.models.verificationCode.update(t.id,{expiresIn:Date.now()+this.codeExpiresIn}),[i,this.decode(t.code)];const r=this.generateVerificationCode();return yield this.models.verificationCode.create({code:this.encode(r),expiresIn:Date.now()+this.codeExpiresIn,userId:i.id}),[i,r]}))}sendVerificationCode(e){return o(this,null,(function*(){const[i,t]=yield this.getVerificationCode(e);return yield this.mailer(i,t),i}))}validateVerificationCode(e,i){return o(this,null,(function*(){const t=yield this.models.user.findByEmail(e);if(!t)throw new c("User not found.");const r=yield this.models.verificationCode.findByUserId(t.id);if(!r)throw new c("Verification code not found.");const n=this.decode(r.code);if(r.expiresIn<Date.now())throw yield this.models.verificationCode.remove(r.id),new c("Verification code expired.");if(n!==i)throw new c("Verification code is incorrect.");yield this.models.verificationCode.remove(r.id);return yield this.models.session.create({user:t,expiresIn:Date.now()+this.sessionExpiresIn})}))}validateUserSession(e){return o(this,null,(function*(){const i=yield this.models.session.findById(e);if(!i)throw new c("Session not found.");if(i.expiresIn<Date.now())throw yield this.models.session.remove(i.id),new c("Session expired.");return i}))}};